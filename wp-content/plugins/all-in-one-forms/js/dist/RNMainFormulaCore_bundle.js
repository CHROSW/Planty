rndefine("#RNMainFormulaCore",["#RNMainCore/Sanitizer","#RNMainCore/EventManager","#RNMainFormBuilderCore/FormBuilder.Options","#RNMainFormBuilderCore/CalculatorBase"],(function(e,t,r,s){"use strict";class i{constructor(e,t){this.Options=e,this.Parent=t}get Retriever(){return this.Parent.Retriever}get Type(){return this.Options.T}}class n{static GetFRElement(e,t){if(null==n.FieldDictionary[e.T])throw new Error("Formula element was not found "+e.T);return new n.FieldDictionary[e.T](e,t)}static AddField(e,t){n.FieldDictionary[e]=t}}n.FieldDictionary={};class a extends i{constructor(e,t,r=null){super(e,null),this.ShouldReturn=!1,this.Sentences=[],this._retriever=t,Array.isArray(null==e?void 0:e.d)&&e.d.forEach((e=>{this.Sentences.push(n.GetFRElement(e,this))}))}get Retriever(){return this._retriever}InternalParse(){let e=null;for(let t of this.Sentences)if(e=t.Parse(),this.ShouldReturn)break;return e}ParsePrice(){return e.Sanitizer.SanitizeNumber(this.Parse())}ParseNumber(){return e.Sanitizer.SanitizeNumber(this.Parse("Num"))}GetType(){return"Main"}ReturnWasExecuted(){this.ShouldReturn=!0}Parse(t=null){let r=this.InternalParse();return(null==r?void 0:r.IsField)?(Array.isArray(r)&&r.reduce(((e,t)=>t.GetNumber()+e),0),"Num"==t?r.GetNumber():"Str"==t?r.GetText():r.GetPrice()):Array.isArray(r)?r.map((t=>e.Sanitizer.SanitizeString(t))).join(", "):null==r?null:r instanceof Date?"Num"==t?class{static UnixToDate(e,t=0){if(null!=e){let r=new Date(1e3*(e+t));return r=new Date(r.setMinutes(r.getMinutes()+r.getTimezoneOffset())),r}return null}static DateToUnix(e,t=0){return(e.getTime()-t)/1e3+-1*e.getTimezoneOffset()*60}}.DateToUnix(r):r.toString():["boolean","string","number"].indexOf(typeof r)>=0?r:r.toString()}ParseString(){return e.Sanitizer.SanitizeString(this.Parse("Str"))}ParseRaw(){return this.InternalParse()}}class u extends i{constructor(e,t){super(e,t)}Parse(){let e=Number(this.Options.d);if(isNaN(e))throw new Error("Invalid number "+e);return e}}n.AddField("NUM",u);class l{static SanitizeNumber(e,t=0){return null==e?t:(null==e?void 0:e.IsField)?e.GetNumber():isNaN(e)?t:Number(e)}static NotifyReturnToParent(e){for(;["BLO","MA","FOR","FE"].indexOf(e.Parent.Options.T)<0;)e=e.Parent;e.Parent.ReturnWasExecuted()}static NotifyBreakToParent(e){for(;["FOR","FE"].indexOf(e.Parent.Options.T)<0;)e=e.Parent;e.Parent.BreakWasExecuted()}}class o extends i{constructor(e,t){super(e,t),this.Statement=n.GetFRElement(e.d,this)}Parse(){return l.NotifyReturnToParent(this),this.Statement.Parse()}}n.AddField("RE",o);class h extends i{constructor(e,t){super(e,t),this.Left=n.GetFRElement(e.L,this),this.Right=n.GetFRElement(e.R,this),this.Subtype=e.St}Parse(){var e,t;let r=this.Left.Parse(),s=this.Right.Parse();switch(this.Subtype){case"Or":return 1==r||1==s;case"And":return 1==r&&1==s;case"Add":return r=(null===(e=r)||void 0===e?void 0:e.IsField)?"string"==typeof s?r.GetText():r.GetNumber():""==r||isNaN(Number(r))?r.toString():Number(r),s=(null===(t=s)||void 0===t?void 0:t.IsField)?"string"==typeof r?s.GetText():s.GetNumber():""==s||isNaN(Number(s))?s.toString():Number(s),r+s;case"Sub":return this.ToNumber(r)-this.ToNumber(s);case"Mult":return this.ToNumber(r)*this.ToNumber(s);case"Div":return s=this.ToNumber(s),0==s?0:this.ToNumber(r)/s;case"Eq":return this.ToScalar(r)==this.ToScalar(s);case"NEq":return this.ToScalar(r)!=this.ToScalar(s);case"Gt":return this.ToScalar(r)>this.ToScalar(s);case"Gte":return this.ToScalar(r)>=this.ToScalar(s);case"Lt":return this.ToScalar(r)<this.ToScalar(s);case"Lte":return this.ToScalar(r)<=this.ToScalar(s)}}ToScalar(e){return Array.isArray(e)?e.reduce(((e,t)=>e+this.ToScalar(t)),0):(null==e?void 0:e.IsField)?e.GetText():e}ToNumber(e){var t;return Array.isArray(e)?e.reduce(((e,t)=>e+this.ToNumber(t)),0):(null===(t=e)||void 0===t?void 0:t.IsField)?e.GetNumber():(e=Number(e),isNaN(e)?0:e)}}n.AddField("BE",h);class c extends i{constructor(e,t){super(e,t),this.Id=this.Options.Id}Parse(){return this.Retriever.GetFieldById(this.Id)}}n.AddField("RNF",c);class d extends i{constructor(e,t){super(e,t),this.Sentence=n.GetFRElement(this.Options.d,this)}Parse(){return this.Sentence.Parse()}}n.AddField("PE",d);class F extends i{constructor(e,t){super(e,t)}Parse(){return null}}n.AddField("Null",F);class p extends i{constructor(e,t){super(e,t)}Parse(){return this.Options.d.toString()}}n.AddField("STR",p);class m extends i{constructor(e,t){super(e,t),this.Items=[],e.d.forEach((e=>{this.Items.push(n.GetFRElement(e,this))}))}Parse(){let e=[];return this.Items.forEach((t=>e.push(t.Parse()))),e}}n.AddField("ARR",m);class P extends i{constructor(e,t){super(e,t),this.Cond=n.GetFRElement(e.C,this),this.Tr=n.GetFRElement(e.Tr,this),this.Fa=n.GetFRElement(e.Fa,this)}Parse(){return this.Cond.Parse()?this.Tr.Parse():this.Fa.Parse()}}n.AddField("CE",P);class R extends i{constructor(e,t){super(e,t)}Parse(){return this.Options.d}}n.AddField("BL",R);class S extends i{constructor(e,t){super(e,t),this.Subt=this.Options.St,"Pr"==this.Options.St?this.Prop=this.Options.Pr:this.Prop=n.GetFRElement(this.Options.Pr,this),this.Caller=n.GetFRElement(this.Options.C,this),this.Args=[],Array.isArray(this.Options.Args)&&this.Options.Args.forEach((e=>this.Args.push(n.GetFRElement(e,this))))}Parse(){let e=this.Caller.Parse();switch(this.Subt){case"Pr":let t=String(this.Prop);return null==e[t]?null:t in e?"function"==typeof e[t]?e[t].apply(e,this.Args.map((e=>e.Parse()))):e[t]:null;case"Arr":let r=this.Prop.Parse();return null==r?null:Array.isArray(e)&&null!=e[r]?e[r]:null}}Assign(e){let t=this.Caller.Parse();switch(this.Subt){case"Arr":let r=this.Prop.Parse(),s=l.SanitizeNumber(r,null);if(null==s)return null;if(!Array.isArray(t)||t.length<s)return null;t[s]=e;break;case"Pr":if(this.Args.length>0)return;let i=String(this.Prop);return i in t?"function"!=typeof t[i]?t[i]=e:void 0:null}}}n.AddField("ME",S);class x{constructor(){this.VarDictionary=new Map,this.FunctionDictionary=x.GlobalFunctions}SetVar(e,t){this.VarDictionary.set(e,t)}GetVar(e){return this.VarDictionary.has(e)?this.VarDictionary.get(e):null}AddFunction(e,t){this.FunctionDictionary.set(e,t)}CallFunction(e,t){return this.FunctionDictionary.has(e)?(t=[this,...t],this.FunctionDictionary.get(e).apply(null,t)):null}}x.GlobalFunctions=new Map;class E extends i{constructor(e,t){super(e,t),this.Asignee=n.GetFRElement(this.Options.As,this),this.Value=n.GetFRElement(this.Options.D,this)}Parse(){let e=this.Value.Parse();this.Asignee.Type,this.Asignee.Assign(e)}}n.AddField("AE",E);class A extends i{constructor(e,t){super(e,t),this.Name=this.Options.d}Parse(){return this.Retriever.GetVar(this.Name)}Assign(e){this.Retriever.SetVar(this.Name,e)}}n.AddField("VAR",A);class y extends i{constructor(e,t){super(e,t),this.Subtype=e.St,this.Expression=n.GetFRElement(this.Options.d,this)}Parse(){return!this.Expression.Parse()}}n.AddField("UE",y);class f extends i{constructor(e,t){super(e,t),this.FunctionName=this.Options.Fn,this.Args=[],this.Options.Ar.forEach((e=>this.Args.push(n.GetFRElement(e,this))))}Parse(){return this.Retriever.CallFunction(this.FunctionName,this.Args.map((e=>e.Parse())))}}n.AddField("FC",f);class N extends i{constructor(e,t){super(e,t),this.Condition=n.GetFRElement(this.Options.Con,this),this.TrueAction=n.GetFRElement(this.Options.Tr,this),null!=this.Options.Fa&&(this.FalseAction=n.GetFRElement(this.Options.Fa,this))}Parse(){return this.Condition.Parse()?this.TrueAction.Parse():null!=this.FalseAction?this.FalseAction.Parse():void 0}}n.AddField("IF",N);class T extends i{constructor(e,t){super(e,t),this.ShouldReturn=!1,this.Sentences=[],this.Options.d.forEach((e=>this.Sentences.push(n.GetFRElement(e,this))))}Parse(){let e=null;for(let t of this.Sentences)if(e=t.Parse(),this.ShouldReturn)break;return e}ReturnWasExecuted(){this.ShouldReturn=!0,l.NotifyReturnToParent(this)}}n.AddField("BLO",T);class G extends i{constructor(e,t){super(e,t),this.ShouldBreak=!1,this.Var=n.GetFRElement(e.V,this),null!=e.C&&(this.Cond=n.GetFRElement(e.C,this)),null!=e.I&&(this.Inc=n.GetFRElement(e.I,this)),this.Statement=n.GetFRElement(e.S,this)}Parse(){this.ShouldBreak=!1,this.Var.Parse();let e=null;for(;null==this.Cond||1==this.Cond.Parse();){var t;if(e=this.Statement.Parse(),this.ShouldBreak)return e;null===(t=this.Inc)||void 0===t||t.Parse()}return e}ReturnWasExecuted(){this.ShouldBreak=!0,l.NotifyReturnToParent(this)}BreakWasExecuted(){this.ShouldBreak=!0}}n.AddField("FOR",G);class b extends i{constructor(e,t){super(e,t)}Parse(){l.NotifyBreakToParent(this)}}n.AddField("BR",b);class g extends i{constructor(e,t){super(e,t),this.Value="",this.Key="",this.ShouldBreak=!1,this.Expression=n.GetFRElement(e.E,this),this.Value=e.V,this.Key=e.K,this.Statement=n.GetFRElement(e.D,this)}Parse(){let e=this.Expression.Parse(),t=[];if(Array.isArray(e))t=Array.from(e.keys());else for(let r in e)t.push(r);for(let r of t){let t=e[r];this.Retriever.SetVar(this.Value,t),""!=this.Key&&this.Retriever.SetVar(this.Key,r);let s=this.Statement.Parse();if(this.ShouldBreak)return s}}ReturnWasExecuted(){this.ShouldBreak=!0,l.NotifyReturnToParent(this)}BreakWasExecuted(){this.ShouldBreak=!0}}n.AddField("FE",g);class O extends x{constructor(e){super(),this.Container=e}GetFieldById(e){return this.Container.GetFieldById(e,!0,!0)}}class C extends s.CalculatorBase{ExecuteCalculation(e,t){return{Quantity:0,RegularPrice:0}}async ExecuteAndUpdate(e=!1,t=!1,r=null){return!this.GetIsUsed()&&this.Field.IsPriceField?this.Field.Calculator.UpdatePrice(0):this.Field.FormulaManager.ExecuteFormulaIfExist("Price",null),!0}}t.EventManager.Subscribe("GetCalculator",(e=>{if("formula"==e)return new C}));class v extends i{constructor(e,t){super(e,t),this.Id=this.Options.Id}Parse(){let t=e.Sanitizer.GetValueFromPath(this.Options,["Op","Id"]),r=e.Sanitizer.GetValueFromPath(this.Retriever,["Container","RootFormBuilder","AdditionalOptions","Attributes",this.Options.Id+(""==t?"":"_"+t)]);return null==r?"":r}}n.AddField("RNFX",v),exports.FRFixed=v,exports.FRMain=a,exports.FRNumber=u,exports.Return=o,exports.FRBinaryExpression=h,exports.FRField=c,exports.ParenthezisedExpression=d,exports.FRNull=F,exports.FRString=p,exports.FRArray=m,exports.FRCondE=P,exports.FRBool=R,exports.FRCondE=P,exports.FRMembE=S,exports.FRDataRetriever=x,exports.FRAssigmentExpression=E,exports.FRVariable=A,exports.UnaryExpression=y,exports.FRFCExpression=f,exports.FRIfStatement=N,exports.FRBlock=T,exports.FRFor=G,exports.FRBreak=b,exports.FRForE=g,exports.FormulaCalculator=C,t.EventManager.Subscribe("CalculateFormula",(e=>{if(null==e.Formula.Compiled)return;let t=new a(e.Formula.Compiled,new O(e.Owner),e.ExecutionChain);try{switch(e.PreferredReturnType||e.Formula.PreferredReturnType){case r.PreferredReturnTypeEnum.String:return t.ParseString();case r.PreferredReturnTypeEnum.Number:return t.ParseNumber();case r.PreferredReturnTypeEnum.Price:return t.ParsePrice();case r.PreferredReturnTypeEnum.Raw:return t.ParseRaw();default:return t.Parse()}}catch(e){return}}))}));
